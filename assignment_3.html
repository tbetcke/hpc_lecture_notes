
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment 3 &#8212; Techniques of High-Performance Computing - Lecture Notes</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Assignment 4" href="assignment_4.html" />
    <link rel="prev" title="Assignment 2" href="assignment_2.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Techniques of High-Performance Computing - Lecture Notes</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Welcome to Techniques of High-Performance Computing
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  High-Performance Computing with Python
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="what_is_hpc.html">
   What is High-Performance Computing?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hpc_languages.html">
   Languages for High-Performance Computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="python_hpc_tools.html">
   Python HPC Tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numpy_and_data_layouts.html">
   Memory layout and Numpy arrays
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parallel_principles.html">
   Parallel Computing Principles in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="working_with_numba.html">
   Working with Numba
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="simd.html">
   SIMD Autovectorization in Numba
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numexpr.html">
   A Numexpr example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="gpu_introduction.html">
   An Introduction to GPU Computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cuda_introduction.html">
   A tour of CUDA
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="numba_cuda.html">
   Numba Cuda in Practice
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rbf_evaluation.html">
   GPU accelerated evaluation of particle sums
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Sparse Linear Algebra
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="sparse_linalg_pde.html">
   The need for sparse linear algebra - A PDE example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sparse_data_structures.html">
   Sparse Matrix data structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sparse_solvers_introduction.html">
   An introduction to sparse linear system solvers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="it_solvers1.html">
   Iterative Solvers 1 - Krylov subspaces, Arnoldi Iteration and the Full Orthogonalisation Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="it_solvers2.html">
   Iterative Solvers 2 - From FOM to GMRES
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="it_solvers3.html">
   Iterative Solvers 3 - The Conjugate Gradient Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="it_solvers4.html">
   Iterative Solvers 4 - Preconditioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sparse_direct_solvers.html">
   Sparse Direct Solvers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="petsc_for_sparse_systems.html">
   Using petsc4py for sparse linear systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="multigrid.html">
   Multigrid Methods
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Time-Dependent Problems
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="simple_time_stepping.html">
   Simple time-stepping
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Assignments
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="assignment_1.html">
   Assignment 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment_2.html">
   Assignment 2
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Assignment 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment_4.html">
   Assignment 4
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/assignment_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/assignment_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-1-improving-the-5-point-stencil-in-cuda">
   Part 1 - Improving the 5-point stencil in CUDA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-2-solving-modifed-helmholtz-problems-with-cg-on-the-gpu">
   Part 2 - Solving modifed Helmholtz problems with CG on the GPU.
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="assignment-3">
<h1>Assignment 3<a class="headerlink" href="#assignment-3" title="Permalink to this headline">¶</a></h1>
<p><strong>Deadline: Monday 30 November, 10am</strong>.</p>
<div class="section" id="part-1-improving-the-5-point-stencil-in-cuda">
<h2>Part 1 - Improving the 5-point stencil in CUDA<a class="headerlink" href="#part-1-improving-the-5-point-stencil-in-cuda" title="Permalink to this headline">¶</a></h2>
<p>In Assignment 2 we implemented the 5-point stencil in CUDA. In this exercise we want to do three changes to the implementation.</p>
<p>1.) In our implementation we generated an operator <span class="math notranslate nohighlight">\(A:\mathbb{R}^{N^2}\rightarrow \mathbb{R}^{N^2}\)</span> that for the vector product <span class="math notranslate nohighlight">\(Ax\)</span> returned the entries <span class="math notranslate nohighlight">\(x_k\)</span> if <span class="math notranslate nohighlight">\(k\)</span> was associated with a boundary coordinate, and the 5-point stencil around <span class="math notranslate nohighlight">\(x_k\)</span> otherwise. We want to modify this a little bit now. Remember that the operator <span class="math notranslate nohighlight">\(A\)</span> discretised the PDE</p>
<div class="math notranslate nohighlight">
\[
-\Delta u = f
\]</div>
<p>for <span class="math notranslate nohighlight">\(u\in [0, 1]^2\)</span> with <span class="math notranslate nohighlight">\(u=g\)</span> on the boundary for a given boundary function <span class="math notranslate nohighlight">\(u\)</span>. We now want to set the boundary values explicitly to zero, that is for each boundary point <span class="math notranslate nohighlight">\(x_k\)</span> we always have <span class="math notranslate nohighlight">\(x_k = 0\)</span>. We can therefore reduce the system to something that only acts on the interior grid points, giving us an operator <span class="math notranslate nohighlight">\(\tilde{A}:\rightarrow \mathbb{R}^{(N-2)^2}\rightarrow\mathbb{R}^{(N-2)^2}\)</span> where the vector <span class="math notranslate nohighlight">\(\tilde{x}\)</span> when we apply <span class="math notranslate nohighlight">\(\tilde{A}\tilde{x}\)</span> only contains the interior points <span class="math notranslate nohighlight">\(u_{i, j}\)</span> for <span class="math notranslate nohighlight">\(0 &lt; i, j &lt; N\)</span>.</p>
<p>2.) We noticed in Assignment 2 that our implementation was inefficient. We had as many accesses to global memory as we had operations in each thread. We want to fix this by using a thread block to read a block of grid points into shared memory so that within the thread block we only need to access the shared memory for evaluating the 5-point stencil. Be careful on the boundary of your thread block. You will need to read in a slightly larger neighborhood around the grid points associated with the threads in your threadblock so that all neighboring points are in shared memory (unless you are at the border of the grid).</p>
<p>3.) We want to allow a larger class of possible PDE problems, namely so called modified Helmholtz problems of the form</p>
<div class="math notranslate nohighlight">
\[
-\Delta u + \omega^2 u = f
\]</div>
<p>with zero boundary conditions. Hand over an optional <code class="docutils literal notranslate"><span class="pre">omega</span></code> parameter to the kernel so that the kernel evaluates the discretisation of this modified Helmholtz problem. For <code class="docutils literal notranslate"><span class="pre">omega=0</span></code> we just have the original Poisson problem.</p>
<p>Modify the implementation from Assignment 2 by integrating these three changes. Think carefully about the local block sizes and explain your implementation and your choice of thread blocks and memory movements thoroughly. Validate your implementation by comparing to evaluations with the matrix <span class="math notranslate nohighlight">\(A\)</span> from the <code class="docutils literal notranslate"><span class="pre">discretise_poisson</span></code> function, where you set the entries of the input vector <span class="math notranslate nohighlight">\(x\)</span> associated with boundary values, explicitly to <span class="math notranslate nohighlight">\(0\)</span>. Note that the matrix <span class="math notranslate nohighlight">\(A\)</span> from <code class="docutils literal notranslate"><span class="pre">discretise_poisson</span></code> returns a vector <span class="math notranslate nohighlight">\(y=Ax\)</span> that contains also the zeros on the boundary. So you need to filter out the boundary values in <span class="math notranslate nohighlight">\(y\)</span> for the validation.</p>
<p>Show benchmark results for your new implementation by comparing timing for matrix-vector products from the previous implementation in Assignment 2. For the timings use the %timeit magic command from Jupyter to achieve high accuracy.</p>
</div>
<div class="section" id="part-2-solving-modifed-helmholtz-problems-with-cg-on-the-gpu">
<h2>Part 2 - Solving modifed Helmholtz problems with CG on the GPU.<a class="headerlink" href="#part-2-solving-modifed-helmholtz-problems-with-cg-on-the-gpu" title="Permalink to this headline">¶</a></h2>
<p>(Hint: If you fail to write a GPU implementation in Part 1, you can also write a CPU implementation so that you can still do Part 2. However, you won’t receive any Part 1 marks for it.)</p>
<p>Your CUDA function from the first part takes a vector and returns a vector. It is an implementation of a linear operator. In Part 2 we want to hook this up with the CG solver from Scipy so that we can solve actual PDE problems on the GPU. In order to do this Scipy provides the class <code class="docutils literal notranslate"><span class="pre">scipy.sparse.linalg.LinearOperator</span></code>. This class is a wrapper for routines that evaluate matrix-vector products and turns them into objects that can be passed to iterative solvers. Wrap your solution from Part 1 into a LinearOperator so that you can interface it with the built-in Scipy iterative solvers. Once you have done this use the CG function from Scipy to solve the linear system of equations</p>
<div class="math notranslate nohighlight">
\[
\tilde{A}x = f,
\]</div>
<p>where <span class="math notranslate nohighlight">\(\tilde{A}\)</span> is represented through your linear operator. For <span class="math notranslate nohighlight">\(f\)</span> simply choose the function with all ones. Make plots of the convergence of the relative residual <span class="math notranslate nohighlight">\(\|Ax_k-f\|_2/\|f\|_2\)</span>. As solver tolerance you can choose the default value. Plot within the same graph the convergence curves for different values of <span class="math notranslate nohighlight">\(\omega &gt; 0\)</span>. Try to explain your observations from what you know about the convergence bounds for CG.</p>
<p>Finally, visualize your PDE solution for <span class="math notranslate nohighlight">\(\omega=1\)</span> using <code class="docutils literal notranslate"><span class="pre">imshow</span></code>.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-dev-py"
        },
        kernelOptions: {
            kernelName: "conda-env-dev-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-dev-py'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="assignment_2.html" title="previous page">Assignment 2</a>
    <a class='right-next' id="next-link" href="assignment_4.html" title="next page">Assignment 4</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Timo Betcke<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>